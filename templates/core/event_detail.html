{% load is_user_subscribed_to_event %}
{% load mathfilters %}
{% load i18n %}

<div id="event_detail_frame">
	<div class="header">
		<h1 class="theme">{{ event.theme }}</h1>
		<div class="button-wrapper">
			<button class="{% if user|is_user_subscribed_to_event:event %}subscribed-button{% else %}subscribe-button{% endif %}" onclick="{% if user|is_user_subscribed_to_event:event %}unsubscribeFromEvent(this, {{ event.pk }}){% else %}subscribeToEvent(this, {{ event.pk }}){% endif %}" subscribers="{{ event.subscribers.count }}">{% if user|is_user_subscribed_to_event:event %}Отписаться{% else %}Подписаться{% endif %} ({{ event.subscribers.count }})</button>
		</div>
	</div>
	<div id="content">
		<!-- <div class="lector"> -->
				{% if event.owner.profile.avatar and event.owner.profile.avatar.url is not None %}
				<div class="avatar">
					<img src="{{ event.owner.profile.avatar.url }}">
				</div>
				{% endif %}
		<!-- </div> -->
		<div class="options">
			<div class="option">
				<div class="key">Лектор</div>
				<div class="value">{{ event.owner.username }}</div>
			</div>
			<div class="option">
				<div class="key">Место проведения</div>
				<div class="value">{{ event.location }}</div>
			</div>
			<div class="option">
				<div class="key">Дата и время начала</div>
				<div class="value">{{ event.event_start_time }}</div>
			</div>
			<div class="option">
				<div class="key">Длительность</div>
				<div class="value">{{ event.duration }}</div>
			</div>
			<div class="option">
				<div class="key">Необходимо подписчиков</div>
				<div class="value">{{ event.need_subscribers }}</div>
			</div>
		</div>
		<div class="description">
		{{ event.description }}
		</div>
		<div id="eventChat" class="chat">
			<div class="comments_count">{% trans 'Количество комментариев' %} - {{ event.chat.count_messages }}</div>
			<div class="messages">
				{% for message in chatMessages %}
				<div class="message">
					<div class="top">
						<div class="author">
							<a class="" href="{% url 'accounts:profile' message.author.username %}">{{ message.author.username }}</a>
						</div>
						<div class="pub_date">{{ message.pub_date }}</div>
					</div>
					<div class="text">{{ message.text }}</div>
					<div class="rating">
						<a class="plus" href="#" onclick="rateMessage({{ message.pk }}, 1, this)">+</a>
						<span class="value" alt="+{{ message.likes_count }} {{ message.dislikes_count }}">{{ message.likes_count|sub:message.dislikes_count }}</span>
						<a class="minus" href="#" onclick="rateMessage({{ message.pk }}, 0, this)">-</a>
					</div>
				</div>
				{% empty %}
				Комментариев нет. Похоже вы будете первым!
				{% endfor %}
			</div>
			<a class="update_button" href="#" onclick="updateChat()">Обновить</a>
		</div>
		<form id="add_comment_form" action="." method="POST">
			{% csrf_token %}
			{{ form.as_p }}
			<input type="submit" value="{% trans 'Отправить' %}">
		</form>
		<script>
		$('#add_comment_form').on('submit', function(event){
		    event.preventDefault();
		    addComment($(this).serialize());
		});
		</script>

		<script>
		function addComment(formData) {
			$.ajax({
				type: 'POST',
				url: '{% url 'chat:addMessage' pk=event.chat.pk %}',
				data: formData,
				success: function(data) {
					showNotification(data.text);
					if(!data.state)
						return;
					updateChat();
					$('#add_comment_form ').find("input[type=text], textarea").val("");
				},
				error: function(xhr, str) {
					alert('Возникла ошибка: ' + xhr.responseCode);
				}
			});
		}

		var n = 0
		function rateMessage(pk, action, element) {
			$.ajax({
				type: 'POST', 
				url: '{% url 'chat:messageVote' pk=999 action=8 %}'.replace('999', pk).replace('8', action),
				success: function(data) {
					var ratingElem = $(element).parent().children('.value');

					if(!data.state) {
						showNotification(data.text);
						return;
					}
					var rating = parseInt(data.likes_count) - parseInt(data.dislikes_count);
					ratingElem.text(rating);
				},
				error:  function(xhr, str){
					alert('Возникла ошибка: ' + xhr.responseCode);
	            }
			});
		}
			function updateChat() {
				$.ajax({
		            type: 'GET',
		            url: '{% url 'chat:getMessages' 999 %}'.replace('999', {{ event.chat.pk }}),
		            success: function(data) {
		                comments_count = data['count_messages'];
		                messagesDom = []
		                for (var i = data['messages'].length - 1; i >= 0; i--) {
		                	message = data['messages'][i];
		                	author = message.author;

		                	messageDom = {
								class: 'message',
								content: [
									{
										class: 'top',
										content: [
											{
												class: 'author',
												content: [
													{
														tag: 'a',
														class: '',
														href: '{% url 'accounts:profile' 'admin' %}'.replace('admin', author.username),
														content: author.first_name.length > 0 ? author.first_name : author.username,
													},
												],
											}, 
											{
												class: 'pub_date',
												content: message['pub_date'],
											},
										]
									},
									{
										class: 'text',
										content: message['text'],
									}, 
									{
										class: 'rating',	
										content: [
											{
												tag: 'a',
												class: 'plus',
												href: '#',
												onclick: "rateMessage(" + message.pk + ", 1, this)",
												content: '+',
											},
											{
												tag: 'span',
												class: 'value',
												content: message.likes_count - message.dislikes_count,
												alt: "+" + message.likes_count + " -" + message.dislikes_count,
											},
											{
												tag: 'a',
												class: 'minus',
												onclick: "rateMessage(" + message.pk + ", 0, this)",
												href: '#',
												content: '-',
											}
										]
										// content: [
										// 	{
										// 		class: 'likes_count',
										// 		content: message['likes_count'],
										// 	}, 
										// 	{
										// 		class: 'dislikes_count',
										// 		content: message['dislikes_count'],
										// 	}, 
										// ]
									}
								], //['text'],
							}; 
							
		                	messagesDom.push(messageDom)
		                };
						chatDom = [
							{
								class: 'comments_count',
								content: 'Количество комментариев - ' + comments_count,
							},
							{
								class: 'messages',
								content: messagesDom,
							},
							{
								tag: 'a',
								href: '#',
								onclick: 'updateChat()',
								content: 'Обновить',
							},
						]
						eventChat.innerHTML = ''
						generateDOM(chatDom, eventChat);
		            },
		            error:  function(xhr, str){
		                alert('Возникла ошибка: ' + xhr.responseCode);
		            }
				});

				

				
			}
		</script>
	</div>
</div>
